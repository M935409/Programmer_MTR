<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title> Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± ÙˆØ§Ù†ØµØ±Ø§Ù Ø§Ù„Ø·Ù„Ø§Ø¨ </title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
    <style>
        body { font-family: 'Tajawal', sans-serif; background-color: #ffffff; color: #1e293b; overflow-x: hidden; }
        
        .table-container { 
            max-height: 75vh; 
            overflow: auto; 
            border-radius: 16px; 
            background: rgb(255, 255, 255);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
            -webkit-overflow-scrolling: touch;
        }

        table thead th { 
            position: sticky; 
            top: 0; 
            z-index: 30; 
            background-color: #1e293b; 
            color: rgb(63, 155, 201); 
            white-space: nowrap; 
            padding: 12px 8px;
        }

        .student-name-col { 
            position: sticky; 
            right: 0; 
            z-index: 40; 
            background-color: #ffffff; 
            min-width: 180px; 
            max-width: 180px;
            box-shadow: -4px 0 10px rgba(0,0,0,0.05);
            font-weight: 700;
            border-left: 2px solid #f1f5f9;
        }

        .index-col {
            width: 40px;
            text-align: center;
            color: #64748b;
            font-size: 11px;
            border-left: 1px solid #f1f5f9;
        }

        .cell-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; padding: 4px; }
        .time-label { font-size: 8px; font-weight: bold; color: #94a3b8; height: 10px; }
        .box-cell { 
            width: 32px; 
            height: 32px; 
            transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
            display: flex; 
            align-items: center; 
            justify-content: center; 
            border-radius: 8px; 
            cursor: pointer; 
            border: 1.5px solid #e2e8f0; 
            font-size: 12px; 
            background: #f8fafc; 
        }
        .checked { 
            background-color: #22c55e !important; 
            color: white !important; 
            border-color: #16a34a !important; 
        }
        
        #customModal { 
            display: none; 
            position: fixed; 
            inset: 0; 
            background: rgba(15, 23, 42, 0.75); 
            align-items: center; 
            justify-content: center; 
            z-index: 1000; 
            backdrop-filter: blur(4px); 
            padding: 16px;
        }

        .tab-btn { 
            padding: 14px 10px; 
            font-weight: 700; 
            transition: 0.3s; 
            border-bottom: 3px solid transparent;
            color: #64748b;
        }
        .tab-btn.active { 
            border-bottom-color: #3b82f6; 
            color: #3b82f6; 
            background: #eff6ff; 
        }
        
        .dep-input { 
            width: 100%; 
            min-width: 100px; 
            padding: 8px; 
            border: 1.5px solid #e2e8f0; 
            border-radius: 8px; 
            font-size: 13px;
        }

        #toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #10b981;
            color: white;
            padding: 12px 24px;
            border-radius: 12px;
            font-weight: bold;
            display: none;
            z-index: 2000;
            box-shadow: 0 10px 15px rgba(0,0,0,0.1);
        }

        @media (max-width: 640px) {
            .student-name-col { min-width: 150px; max-width: 150px; font-size: 12px; }
            .box-cell { width: 28px; height: 28px; }
        }
    </style>
</head>
<body class="p-2 md:p-6">

<div id="toast">ØªÙ…Øª Ø§Ù„Ø¹Ù…Ù„ÙŠØ© Ø¨Ù†Ø¬Ø§Ø­ âœ…</div>

<div class="max-w-full mx-auto">
    <!-- Header -->
    <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm mb-4">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 id="pageMainTitle" class="text-xl md:text-3xl font-bold text-slate-800">Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ù„Ø§Ø¨</h1>
                <div class="flex items-center gap-2 mt-2">
                    <div id="activeMonthDisplay" class="bg-slate-800 text-blue-400 px-4 py-1 rounded-full font-bold text-xs md:text-sm border border-blue-500/30">
                        Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
                    </div>
                    <div id="studentsCountDisplay" class="bg-emerald-50 text-emerald-700 px-4 py-1 rounded-full font-bold text-xs md:text-sm border border-emerald-200">
                        Ø§Ù„Ø¹Ø¯Ø¯: 0
                    </div>
                </div>
            </div>
            <div class="flex flex-wrap gap-2">
                <input type="text" id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨..." class="flex-1 md:w-64 px-4 py-2 rounded-xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none text-sm"/>
                <div class="flex gap-2 w-full md:w-auto">
                    <button id="addStudentBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-xl font-bold transition-all text-xs">Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø§Ø¨</button>
                    <button id="settingsBtn" class="flex-1 bg-slate-800 hover:bg-slate-900 text-white py-2 px-4 rounded-xl font-bold transition-all text-xs">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="flex bg-white rounded-2xl mb-4 border border-slate-200 overflow-hidden shadow-sm">
        <button onclick="switchView('attendance')" id="tabAtt" class="tab-btn active flex-1">ğŸ“… Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±</button>
        <button onclick="switchView('departure')" id="tabDep" class="tab-btn flex-1">ğŸš€ Ø³Ø¬Ù„ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù</button>
    </div>

    <!-- Attendance Table -->
    <div id="attendanceSection" class="table-container border border-slate-200">
        <table class="w-full border-collapse">
            <thead>
                <tr>
                    <th class="student-name-col">
                        <div class="flex items-center">
                            <span class="w-[40px] text-center border-l border-slate-600 opacity-60">#</span>
                            <span class="pr-2">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨/Ø©</span>
                        </div>
                    </th>
                    <script>for(let d=1; d<=31; d++){document.write(`<th class="text-center min-w-[45px] border-r border-slate-700 text-[10px]">${d}</th>`);}</script>
                </tr>
            </thead>
            <tbody id="attendanceBody" class="divide-y divide-slate-100"></tbody>
        </table>
    </div>

    <!-- Departure Table -->
    <div id="departureSection" class="table-container border border-slate-200 hidden">
        <table class="w-full border-collapse">
            <thead>
                <tr>
                    <th class="student-name-col">
                         <div class="flex items-center">
                            <span class="w-[40px] text-center border-l border-slate-600 opacity-60">#</span>
                            <span class="pr-2">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨/Ø©</span>
                        </div>
                    </th>
                    <th class="p-4 text-xs font-bold min-w-[120px]">Ø§Ù„ÙˆØ¬Ù‡Ø© (Ø§Ù„Ù…ÙƒØ§Ù†)</th>
                    <th class="p-4 text-xs font-bold min-w-[110px]">Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„Ùƒ</th>
                    <th class="p-4 text-xs font-bold min-w-[110px]">Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ù…Ø±Ø§ÙÙ‚ Ø§Ùˆ Ø´Ø®Øµ Ù…ØªÙˆØ§Ø¬Ø¯ ÙÙŠ Ø§Ù„ÙˆØ¬Ù‡Ø©</th>
                    <th class="p-4 text-xs font-bold min-w-[90px]">ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬</th>
                    <th class="p-4 text-xs font-bold min-w-[90px]">ÙˆÙ‚Øª Ø§Ù„Ø¹ÙˆØ¯Ø©</th>
                    <th class="p-4 text-xs font-bold">Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
            </thead>
            <tbody id="departureBody" class="divide-y divide-slate-100"></tbody>
        </table>
    </div>

    <div id="loader" class="hidden flex justify-center py-12">
        <div class="animate-spin rounded-full h-10 w-10 border-4 border-blue-600 border-t-transparent"></div>
    </div>
</div>

<!-- Modal -->
<div id="customModal">
    <div class="bg-white p-6 rounded-3xl shadow-2xl max-w-sm w-full relative border border-slate-100 max-h-[90vh] overflow-y-auto">
        <div id="modalIcon" class="mx-auto flex items-center justify-center h-14 w-14 rounded-full mb-4 font-bold text-2xl"></div>
        <h3 class="text-lg font-bold text-center text-slate-800 mb-2" id="modalTitle"></h3>
        
        <div id="modalBodyContent" class="mb-6">
            <p class="text-slate-500 text-center text-sm mb-4 leading-relaxed" id="modalMessage"></p>
            
            <div id="errorMsg" class="hidden bg-red-50 text-red-600 p-2 rounded-lg text-xs text-center mb-4 border border-red-100 font-bold">
                âš ï¸ Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±Øº
            </div>

            <!-- Single Inputs -->
            <div id="modalInputContainer" class="hidden mb-4 space-y-3">
                <input type="password" id="modalInput" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-center font-bold tracking-widest" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
                <input type="password" id="modalInputConfirm" class="hidden w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-center font-bold tracking-widest" placeholder="ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±Ù…Ø² â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>

            <!-- Multi Student Input (Add) -->
            <div id="multiStudentContainer" class="hidden mb-4 max-h-[300px] overflow-y-auto border border-slate-200 rounded-xl">
                <table class="w-full text-sm text-right">
                    <thead class="bg-slate-50 sticky top-0">
                        <tr>
                            <th class="p-2 border-b">#</th>
                            <th class="p-2 border-b">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨ Ø±Ø¨Ø§Ø¹ÙŠ</th>
                        </tr>
                    </thead>
                    <tbody id="multiStudentBody"></tbody>
                </table>
            </div>

            <!-- Multi Student Delete (Checkboxes) -->
            <div id="deleteSelectionContainer" class="hidden mb-4 max-h-[300px] overflow-y-auto border border-slate-200 rounded-xl p-2 space-y-2">
                <div class="flex items-center gap-2 p-2 bg-slate-50 rounded-lg mb-2">
                    <input type="checkbox" id="selectAllStudents" class="w-4 h-4 accent-red-600">
                    <label for="selectAllStudents" class="text-xs font-bold text-slate-700">ØªØ­Ø¯ÙŠØ¯ Ø§Ù„ÙƒÙ„</label>
                </div>
                <div id="deleteListBody" class="space-y-1"></div>
            </div>

            <div id="modalSelectContainer" class="hidden mb-4">
                <select id="modalSelect" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"></select>
            </div>

            <div id="settingsContainer" class="hidden space-y-3">
                <p class="text-[10px] text-red-500 text-center font-bold mb-2"> ØªÙ†Ø¨ÙŠØ©âš ï¸ . Ù‡Ø°Ù‡ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø®Ø§ØµØ© Ø¨Ø§Ù„Ø¥Ø¯Ø§Ø±Ø© ÙÙ‚Ø·</p>
                <button onclick="triggerMonthChange()" class="w-full bg-blue-50 text-blue-700 py-3 rounded-xl font-bold text-sm border border-blue-100 hover:bg-blue-100">ğŸ“… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
                <button onclick="triggerPasswordChange()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold text-sm hover:bg-slate-900">ğŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
                <button onclick="triggerMultiDelete()" class="w-full bg-white text-red-600 py-3 rounded-xl font-bold text-sm border border-red-200 hover:bg-red-50">ğŸ—‘ï¸ Ø­Ø°Ù Ø·Ù„Ø§Ø¨ (ØªØ­Ø¯ÙŠØ¯ Ù…ØªØ¹Ø¯Ø¯)</button>
                <div class="space-y-1">
                    <button onclick="triggerClearAttendance()" class="w-full bg-red-50 text-red-700 py-3 rounded-xl font-bold text-sm border border-red-100 hover:bg-red-100">ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„Ø§Øª (ØªØµÙÙŠØ© Ø´Ø§Ù…Ù„Ø©)</button>
                    <p class="text-[9px] text-slate-400 text-center leading-tight">ÙŠÙØ³ØªØ®Ø¯Ù… Ù‡Ø°Ø§ Ø§Ù„Ø²Ø± Ø¹Ù†Ø¯ Ø¨Ø¯Ø§ÙŠØ© Ø´Ù‡Ø± Ø¬Ø¯ÙŠØ¯ Ù„Ù…Ø³Ø­ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù Ù…Ø¹Ø§Ù‹.</p>
                </div>
                <button onclick="triggerPrivacyPolicy()" class="w-full bg-emerald-50 text-emerald-700 py-3 rounded-xl font-bold text-sm border border-emerald-100 hover:bg-emerald-100">ğŸ›¡ï¸ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</button>
            </div>

           <div id="privacyContainer" class="hidden">
    <div class="bg-slate-50 p-5 rounded-2xl text-slate-600 text-xs leading-relaxed text-right border border-slate-200">
        <p class="font-bold text-slate-800 mb-3 text-center text-sm">
            Ù…ÙŠØ«Ø§Ù‚ Ø§Ù„Ø®ØµÙˆØµÙŠØ© Ø§Ù„Ø±Ù‚Ù…ÙŠ
        </p>

        <ul class="space-y-2">
            <li>âœ¦ Ø§Ù„Ù…ÙˆÙ‚Ø¹ Ù…Ø®ØµØµ Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØªÙ†Ø¸ÙŠÙ… Ø´Ø¤ÙˆÙ† Ø¯Ø§Ø®Ù„ÙŠØ© Ø§Ù„Ø·Ø§Ù„Ø¨Ø§Øª ÙÙ‚Ø·.</li>
            <li>âœ¦ Ù†Ø¸Ø§Ù… Ø®Ø§Øµ ÙˆØ¢Ù…Ù† ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„ÙŠÙ‡ Ø¥Ù„Ø§ Ù„Ù„Ù…ØµØ±Ù‘Ø­ Ù„Ù‡Ù….</li>
            <li>âœ¦ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø­ÙÙˆØ¸Ø© ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø´ÙÙ‘Ø±Ø© ÙˆÙ…Ø­Ù…ÙŠØ© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„.</li>
            <li>âœ¦ ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù… ØªÙ‚Ù†ÙŠØ§Øª Ø­Ù…Ø§ÙŠØ© Ø­Ø¯ÙŠØ«Ø© Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø®ØµÙˆØµÙŠØ© ÙˆØ³Ù„Ø§Ù…Ø© Ø§Ù„Ù…Ø¹Ù„ÙˆÙ…Ø§Øª.</li>
            <li>âœ¦ Ù„Ø§ ÙŠÙØ³Ù…Ø­ Ø¨Ø§Ù„ÙˆØµÙˆÙ„ Ø£Ùˆ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø¹Ù„Ù‰ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¥Ù„Ø§ Ø¹Ø¨Ø± Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø±Ø³Ù…ÙŠ Ù„Ù„Ù…ÙˆÙ‚Ø¹.</li>
        </ul>

        <!-- Ø§Ù„ØªÙˆÙ‚ÙŠØ¹ -->
        <div class="mt-4 text-center text-[11px] text-blue-500/70 tracking-wide italic">
            Programmer by Muhab<br>
            Ø±Ù‚Ù… Ø§Ù„ØªØ­Ø¯ÙŠØ«: 1.1.1
        </div>
    </div>
</div>
</div>

<div id="modalButtons" class="flex gap-3">
    <button id="modalConfirmBtn"
        class="flex-[2] bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold text-sm transition-all">
        ØªØ£ÙƒÙŠØ¯
    </button>

    <button id="modalCancelBtn" onclick="closeModal()"
        class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-600 py-3 rounded-xl font-bold text-sm transition-all">
        Ø¥Ù„ØºØ§Ø¡
    </button>
</div>
</div>
</div>

<script>
const SUPABASE_URL="https://uobfgucxxvxfxljrfwwk.supabase.co";
const SUPABASE_KEY="sb_publishable_lxOLW0vNtZDCtd4X-2UgiQ_4g60N8Kn";
const sbClient=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

const attBody=document.getElementById("attendanceBody");
const depBody=document.getElementById("departureBody");
const loader=document.getElementById("loader");
const searchInput=document.getElementById("search");
const modal=document.getElementById("customModal");
const activeMonthDisplay = document.getElementById('activeMonthDisplay');
const studentsCountDisplay = document.getElementById('studentsCountDisplay');
const toast = document.getElementById('toast');

let currentView = 'attendance';
let studentsList = [];
let attendanceRecords = []; 
let pendingAction = null;

const monthsList = ["ÙŠÙ†Ø§ÙŠØ± - 1", "ÙØ¨Ø±Ø§ÙŠØ± - 2", "Ù…Ø§Ø±Ø³ - 3", "Ø£Ø¨Ø±ÙŠÙ„ - 4", "Ù…Ø§ÙŠÙˆ - 5", "ÙŠÙˆÙ†ÙŠÙˆ - 6", "ÙŠÙˆÙ„ÙŠÙˆ - 7", "Ø£ØºØ³Ø·Ø³ - 8", "Ø³Ø¨ØªÙ…Ø¨Ø± - 9", "Ø£ÙƒØªÙˆØ¨Ø± - 10", "Ù†ÙˆÙÙ…Ø¨Ø± - 11", "Ø¯ÙŠØ³Ù…Ø¨Ø± - 12"];

function switchView(view) {
    currentView = view;
    document.getElementById('attendanceSection').classList.toggle('hidden', view !== 'attendance');
    document.getElementById('departureSection').classList.toggle('hidden', view !== 'departure');
    document.getElementById('tabAtt').classList.toggle('active', view === 'attendance');
    document.getElementById('tabDep').classList.toggle('active', view === 'departure');
    document.getElementById('pageMainTitle').textContent = (view === 'attendance') ? 'Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ù„Ø§Ø¨' : 'Ø³Ø¬Ù„ Ø§Ù†ØµØ±Ø§Ù Ø§Ù„Ø·Ù„Ø§Ø¨';
    renderData();
}

function showToast(msg) {
    toast.textContent = msg;
    toast.style.display = 'block';
    setTimeout(() => { toast.style.display = 'none'; }, 3000);
}

function getCurrentTimeFormatted() {
    const now = new Date();
    let hours = now.getHours();
    const minutes = now.getMinutes().toString().padStart(2, '0');
    const ampm = hours >= 12 ? 'Ù…' : 'Øµ';
    hours = hours % 12 || 12; 
    return `${hours}:${minutes} ${ampm}`;
}

async function checkAdminPassword(providedPwd) {
    if(!providedPwd || providedPwd.trim() === "") {
        showErrorOnInput();
        return false;
    }
    const {data} = await sbClient.from("settings").select("value").eq("key_name", "admin_password").single();
    if(data && data.value === providedPwd) return true;
    showErrorOnInput();
    return false;
}

function showErrorOnInput(customMsg) {
    const errorDiv = document.getElementById('errorMsg');
    if(customMsg) errorDiv.textContent = customMsg;
    errorDiv.classList.remove('hidden');
    document.getElementById('modalInput').classList.add('border-red-500', 'bg-red-50');
    setTimeout(() => {
        errorDiv.classList.add('hidden');
        document.getElementById('modalInput').classList.remove('border-red-500', 'bg-red-50');
    }, 3000);
}

function showCustomUI({title, message, type='info', showInput=false, inputType="password", showConfirmField=false, showSelect=false, selectData=[], onConfirm, showSettings=false, showPrivacy=false, showMultiInput=false, multiCount=0, showDeleteList=false, hideConfirm=false, hideCancel=false, confirmText="ØªØ£ÙƒÙŠØ¯"}){
    document.getElementById('modalTitle').textContent=title;
    document.getElementById('modalMessage').innerHTML=message;
    const iconDiv=document.getElementById('modalIcon');
    const confirmBtn = document.getElementById('modalConfirmBtn');
    const cancelBtn = document.getElementById('modalCancelBtn');

    confirmBtn.textContent = confirmText;
    confirmBtn.style.display = hideConfirm ? "none" : "block";
    cancelBtn.style.display = hideCancel ? "none" : "block";
    
    ['settingsContainer', 'privacyContainer', 'modalInputContainer', 'modalSelectContainer', 'multiStudentContainer', 'deleteSelectionContainer'].forEach(id => document.getElementById(id).classList.add('hidden'));
    document.getElementById('modalInputConfirm').classList.add('hidden');
    
    if(type==='success') { iconDiv.className="mx-auto flex items-center justify-center h-14 w-14 rounded-full mb-4 bg-green-100 text-green-600"; iconDiv.innerHTML='âœ”'; }
    else if(type==='danger') { iconDiv.className="mx-auto flex items-center justify-center h-14 w-14 rounded-full mb-4 bg-red-100 text-red-600"; iconDiv.innerHTML='âš '; }
    else if(type==='shield') { iconDiv.className="mx-auto flex items-center justify-center h-14 w-14 rounded-full mb-4 bg-emerald-100 text-emerald-600"; iconDiv.innerHTML='ğŸ›¡ï¸'; }
    else { iconDiv.className="mx-auto flex items-center justify-center h-14 w-14 rounded-full mb-4 bg-blue-100 text-blue-600"; iconDiv.innerHTML='â„¹'; }

    if(showInput) { 
        document.getElementById('modalInputContainer').classList.remove('hidden'); 
        document.getElementById('modalInput').type=inputType; 
        document.getElementById('modalInput').value=""; 
        if(showConfirmField) {
            document.getElementById('modalInputConfirm').classList.remove('hidden');
            document.getElementById('modalInputConfirm').type=inputType;
            document.getElementById('modalInputConfirm').value="";
        }
    }

    if(showMultiInput) {
        const body = document.getElementById('multiStudentBody');
        body.innerHTML = "";
        for(let i=1; i<=multiCount; i++) {
            body.innerHTML += `<tr class="border-b"><td class="p-2 bg-slate-50 text-center font-bold text-slate-400">${i}</td><td class="p-1"><input type="text" class="multi-name-input w-full p-2 outline-none border-0 focus:bg-blue-50" placeholder="Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨..."></td></tr>`;
        }
        document.getElementById('multiStudentContainer').classList.remove('hidden');
    }

    if(showDeleteList) {
        const listBody = document.getElementById('deleteListBody');
        listBody.innerHTML = studentsList.map((s, idx) => `
            <div class="flex items-center gap-2 p-2 hover:bg-slate-50 rounded-lg transition-colors border-b border-slate-50">
                <input type="checkbox" value="${s.id}" class="student-delete-checkbox w-4 h-4 accent-red-600">
                <span class="text-[10px] bg-slate-100 px-1.5 rounded text-slate-400">${idx+1}</span>
                <span class="text-xs font-medium text-slate-700">${s.name}</span>
            </div>
        `).join("");
        document.getElementById('deleteSelectionContainer').classList.remove('hidden');
        
        document.getElementById('selectAllStudents').checked = false;
        document.getElementById('selectAllStudents').onchange = (e) => {
            document.querySelectorAll('.student-delete-checkbox').forEach(cb => cb.checked = e.target.checked);
        };
    }

    if(showSelect) { 
        document.getElementById('modalSelectContainer').classList.remove('hidden'); 
        document.getElementById('modalSelect').innerHTML = selectData.map(s => `<option value="${s.id||s}">${s.name||s}</option>`).join("");
    }
    if(showSettings) document.getElementById('settingsContainer').classList.remove('hidden');
    if(showPrivacy) document.getElementById('privacyContainer').classList.remove('hidden');

    modal.style.display="flex";
    pendingAction = async () => {
        let val;
        if(showMultiInput) {
            val = Array.from(document.querySelectorAll('.multi-name-input')).map(inp => inp.value.trim()).filter(v => v !== "");
        } else if(showDeleteList) {
            val = Array.from(document.querySelectorAll('.student-delete-checkbox:checked')).map(cb => cb.value);
        } else {
            val = showSelect ? document.getElementById('modalSelect').value : document.getElementById('modalInput').value;
        }
        const confirmVal = document.getElementById('modalInputConfirm').value;
        if(onConfirm) await onConfirm(val, confirmVal);
    };
}

function closeModal(){ modal.style.display="none"; pendingAction=null; }

document.getElementById('modalConfirmBtn').onclick= async ()=>{ if(pendingAction) await pendingAction(); };

async function loadAllData() {
    loader.classList.remove('hidden');
    const [studentsRes, attendanceRes, settingsRes] = await Promise.all([
        sbClient.from("students").select("*").order("name"),
        sbClient.from("attendance").select("*"),
        sbClient.from("settings").select("value").eq("key_name", "active_month").single()
    ]);

    studentsList = studentsRes.data || [];
    attendanceRecords = attendanceRes.data || [];
    if(settingsRes.data) activeMonthDisplay.textContent = settingsRes.data.value;
    studentsCountDisplay.textContent = `Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø§Ù†: ${studentsList.length}`;

    renderData();
    loader.classList.add('hidden');
}

function renderData() {
    const filter = searchInput.value.toLowerCase();
    const filtered = studentsList.filter(s => s.name.toLowerCase().includes(filter));

    if(currentView === 'attendance') {
        attBody.innerHTML = "";
        filtered.forEach((student, index) => {
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td class="student-name-col pr-0">
                    <div class="flex items-center">
                        <span class="index-col">${index + 1}</span>
                        <span class="pr-2">${student.name}</span>
                    </div>
                </td>`;
            const studentAtt = attendanceRecords.filter(a => a.student_id === student.id);
            const attMap = {};
            studentAtt.forEach(a => attMap[a.day] = a.check_time);
            for(let d=1; d<=31; d++) {
                const time = attMap[d] || '';
                const isChecked = !!time;
                tr.innerHTML += `<td class="p-0 border-r border-slate-100"><div class="cell-wrapper"><span class="time-label" id="time-${student.id}-${d}">${time}</span><div onclick="handleToggleAtt(this, '${student.id}', ${d}, '${student.name}')" class="box-cell ${isChecked?'checked':''}" id="box-${student.id}-${d}">${isChecked?'âœ”':''}</div></div></td>`;
            }
            attBody.appendChild(tr);
        });
    } else {
        depBody.innerHTML = "";
        filtered.forEach(async (student, index) => {
            const {data:d} = await sbClient.from("departures").select("*").eq("student_id", student.id).single();
            const dep = d || { destination:'', phone:'', relative_phone:'', out_time:'', return_time:'' };
            const tr = document.createElement("tr");
            tr.innerHTML = `
                <td class="student-name-col pr-0">
                    <div class="flex items-center">
                        <span class="index-col">${index + 1}</span>
                        <span class="pr-2">${student.name}</span>
                    </div>
                </td>
                <td class="p-2"><input id="dest-${student.id}" value="${dep.destination}" class="dep-input" placeholder="..."></td>
                <td class="p-2"><input id="ph-${student.id}" value="${dep.phone}" class="dep-input" placeholder="..."></td>
                <td class="p-2"><input id="rel-${student.id}" value="${dep.relative_phone}" class="dep-input" placeholder="..."></td>
                <td class="p-2"><input id="out-${student.id}" value="${dep.out_time}" class="dep-input" placeholder="..."></td>
                <td class="p-2"><input id="ret-${student.id}" value="${dep.return_time}" class="dep-input" placeholder="..."></td>
                <td class="p-2 text-center"><button onclick="saveDeparture('${student.id}')" class="bg-green-600 text-white px-4 py-1.5 rounded-lg font-bold text-xs">Ø­ÙØ¸</button></td>`;
            depBody.appendChild(tr);
        });
    }
}

async function handleToggleAtt(box, sid, day, sname) {
    const isRemoving = box.classList.contains('checked');
    const timeLabel = document.getElementById(`time-${sid}-${day}`);
    showCustomUI({
        title: isRemoving ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¶ÙˆØ±' : 'ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±',
        message: `Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© (${sname})ØŸ`,
        type: isRemoving ? 'danger' : 'success',
        onConfirm: async () => {
            closeModal();
            const nowTime = getCurrentTimeFormatted();
            if(isRemoving) {
                box.classList.remove('checked'); box.innerHTML = ""; timeLabel.textContent = "";
            } else {
                box.classList.add('checked'); box.innerHTML = "âœ”"; timeLabel.textContent = nowTime;
            }
            try {
                if(isRemoving) {
                    await sbClient.from("attendance").delete().eq("student_id", sid).eq("day", day);
                    attendanceRecords = attendanceRecords.filter(a => !(a.student_id === sid && a.day === day));
                } else {
                    await sbClient.from("attendance").upsert({ student_id: sid, day: day, status: 'Ø­Ø¶ÙˆØ±', check_time: nowTime });
                    attendanceRecords.push({ student_id: sid, day: day, status: 'Ø­Ø¶ÙˆØ±', check_time: nowTime });
                }
            } catch (err) { console.error(err); }
        }
    });
}

async function saveDeparture(sid) {
    const payload = {
        student_id: sid,
        destination: document.getElementById(`dest-${sid}`).value,
        phone: document.getElementById(`ph-${sid}`).value,
        relative_phone: document.getElementById(`rel-${sid}`).value,
        out_time: document.getElementById(`out-${sid}`).value,
        return_time: document.getElementById(`ret-${sid}`).value
    };
    await sbClient.from("departures").upsert(payload, {onConflict: 'student_id'});
    showToast("ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø§Ù†ØµØ±Ø§Ù");
}

function triggerMonthChange() {
    showCustomUI({title:'ØªØ­Ù‚Ù‚', message:'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ:', showInput:true, onConfirm: async (pwd) => {
        if(await checkAdminPassword(pwd)) {
            setTimeout(() => showCustomUI({title:'ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ù‡Ø±', message:'Ø§Ø®ØªØ± Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø±Ø§Ø¯ ØªÙØ¹ÙŠÙ„Ù‡:', showSelect:true, selectData:monthsList, onConfirm: async (m) => {
                await sbClient.from("settings").update({value: m}).eq("key_name", "active_month");
                activeMonthDisplay.textContent = m;
                closeModal(); showToast("ØªÙ… ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ù‡Ø± Ø¨Ù†Ø¬Ø§Ø­");
            }}), 300);
        }
    }});
}

function triggerPasswordChange() {
    showCustomUI({title:'ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù…Ø²', message:'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£ÙˆÙ„Ø§Ù‹:', showInput:true, onConfirm: async (pwd) => {
        if(await checkAdminPassword(pwd)) {
            setTimeout(() => showCustomUI({
                title:'Ø±Ù…Ø² Ø¬Ø¯ÙŠØ¯', 
                message:'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ£ÙƒØ¯Ù‡ Ø¨Ø§Ù„Ø£Ø³ÙÙ„:', 
                showInput:true, 
                inputType:'text', 
                showConfirmField:true, 
                onConfirm: async (newPwd, confirmPwd) => {
                    if(!newPwd || newPwd.length < 4) { showErrorOnInput("Ø§Ù„Ø±Ù…Ø² Ù‚ØµÙŠØ± Ø¬Ø¯Ø§Ù‹"); return; }
                    if(newPwd !== confirmPwd) { showErrorOnInput("Ø§Ù„Ø±Ù…Ø²Ø§Ù† ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚ÙŠÙ†!"); return; }
                    await sbClient.from("settings").update({value: newPwd}).eq("key_name", "admin_password");
                    closeModal(); showToast("ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­ âœ…");
            }}), 300);
        }
    }});
}

function triggerMultiDelete() {
    showCustomUI({title:'Ø­Ø°Ù Ù…ØªØ¹Ø¯Ø¯', message:'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©:', showInput:true, onConfirm: async (pwd) => {
        if(await checkAdminPassword(pwd)) {
            setTimeout(() => showCustomUI({
                title:'ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ù„Ù„Ø­Ø°Ù', 
                message:'ÙŠØ±Ø¬Ù‰ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø­Ø°ÙÙ‡Ø§ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹:', 
                showDeleteList:true, 
                type:'danger',
                confirmText: 'Ø­Ø°Ù Ø§Ù„Ù…Ø­Ø¯Ø¯',
                onConfirm: async (ids) => {
                    if(!ids || ids.length === 0) { closeModal(); return; }
                    loader.classList.remove('hidden');
                    await sbClient.from("students").delete().in("id", ids);
                    closeModal();
                    loadAllData();
                    showToast(`ØªÙ… Ø­Ø°Ù ${ids.length} Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­`);
                }
            }), 300);
        }
    }});
}

function triggerClearAttendance() {
    showCustomUI({title:'ØªØµÙÙŠØ© Ø§Ù„Ø³Ø¬Ù„Ø§Øª', message:'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©:', showInput:true, type:'danger', onConfirm: async (pwd) => {
        if(await checkAdminPassword(pwd)) {
            setTimeout(() => showCustomUI({
                title: 'ØªØ£ÙƒÙŠØ¯ Ø§Ù„ØªØµÙÙŠØ© Ø§Ù„Ø´Ø§Ù…Ù„Ø©',
                message: 'Ø³ÙŠØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ£ÙŠØ¶Ø§Ù‹ Ø¨ÙŠØ§Ù†Ø§Øª Ø³Ø¬Ù„ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù Ù„Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ø³ØªØ¹Ø¯Ø§Ø¯Ø§Ù‹ Ù„Ø¨Ø¯Ø§ÙŠØ© Ø´Ù‡Ø± Ø¬Ø¯ÙŠØ¯. Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ',
                type: 'danger',
                onConfirm: async () => {
                    const p1 = sbClient.from("attendance").delete().neq("status", "none");
                    const p2 = sbClient.from("departures").delete().neq("destination", "none");
                    await Promise.all([p1, p2]);
                    closeModal(); loadAllData(); showToast("ØªÙ… ØªØµÙÙŠØ± Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø¨Ù†Ø¬Ø§Ø­");
                }
            }), 300);
        }
    }});
}

function triggerPrivacyPolicy() {
    showCustomUI({ title: 'Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©', message: 'Ù…Ø¹Ù„ÙˆÙ…Ø§Øª Ø­ÙˆÙ„ Ø­Ù…Ø§ÙŠØ© Ø¨ÙŠØ§Ù†Ø§ØªÙƒ:', type: 'shield', showPrivacy: true, confirmText: 'ÙÙ‡Ù…Øª', hideCancel: true, onConfirm: () => closeModal() });
}

document.getElementById("settingsBtn").onclick = () => showCustomUI({title:'Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ù†Ø¸Ø§Ù…', message:'Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠØ©:', showSettings:true, hideConfirm:true});

document.getElementById("addStudentBtn").onclick = () => {
    showCustomUI({title:'Ø¥Ø¶Ø§ÙØ© Ø·Ù„Ø§Ø¨', message:'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©:', showInput:true, onConfirm: async (pwd) => {
        if(await checkAdminPassword(pwd)) {
            setTimeout(() => showCustomUI({title:'ÙƒÙ… Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ØŸ', message:'Ø­Ø¯Ø¯ Ø¹Ø¯Ø¯ Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ù…Ø±Ø§Ø¯ Ø¥Ø¶Ø§ÙØªÙ‡Ù… Ø§Ù„Ø¢Ù†:', showInput:true, inputType:'number', onConfirm: (count) => {
                const num = parseInt(count);
                if(isNaN(num) || num <= 0) { showErrorOnInput("ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø¹Ø¯Ø¯ ØµØ­ÙŠØ­"); return; }
                setTimeout(() => showCustomUI({
                    title:'Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø§Ø¨ Ø§Ù„Ø¬Ø¯Ø¯', 
                    message:'ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ ÙÙŠ Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø£Ø¯Ù†Ø§Ù‡:', 
                    showMultiInput:true, 
                    multiCount:num,
                    confirmText: 'Ø­ÙØ¸ Ø§Ù„ÙƒÙ„',
                    onConfirm: async (namesArray) => {
                        if(namesArray.length === 0) { closeModal(); return; }
                        loader.classList.remove('hidden');
                        const dataToInsert = namesArray.map(n => ({ name: n }));
                        await sbClient.from("students").insert(dataToInsert);
                        closeModal(); loadAllData(); showToast(`ØªÙ…Øª Ø¥Ø¶Ø§ÙØ© ${namesArray.length} Ø·Ø§Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­`);
                    }
                }), 300);
            }}), 300);
        }
    }});
};

searchInput.oninput = () => renderData();
window.onload = loadAllData;
</script>
</body>
</html>
