<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title> Ù†Ø¸Ø§Ù… Ø­Ø¶ÙˆØ± ÙˆØ§Ù†ØµØ±Ø§Ù Ø§Ù„Ø·Ù„Ø§Ø¨ </title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="https://cdn.tailwindcss.com"></script>
<link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700&display=swap" rel="stylesheet">
<style>
    body { font-family: 'Tajawal', sans-serif; background-color: #f1f5f9; color: #1e293b; overflow-x: hidden; }
    
    .table-container { 
        max-height: 75vh; 
        overflow: auto; 
        border-radius: 16px; 
        background: white;
        box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        -webkit-overflow-scrolling: touch;
    }

    table thead th { 
        position: sticky; 
        top: 0; 
        z-index: 30; 
        background-color: #1e293b; 
        color: white; 
        white-space: nowrap; 
        padding: 12px 8px;
    }

    .student-name-col { 
        position: sticky; 
        right: 0; 
        z-index: 40; 
        background-color: #ffffff; 
        min-width: 140px; 
        max-width: 140px;
        box-shadow: -4px 0 10px rgba(0,0,0,0.05);
        font-weight: 700;
        border-left: 2px solid #f1f5f9;
    }

    .cell-wrapper { display: flex; flex-direction: column; align-items: center; justify-content: center; gap: 4px; padding: 4px; }
    .time-label { font-size: 8px; font-weight: bold; color: #94a3b8; height: 10px; }
    .box-cell { 
        width: 32px; 
        height: 32px; 
        transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
        display: flex; 
        align-items: center; 
        justify-content: center; 
        border-radius: 8px; 
        cursor: pointer; 
        border: 1.5px solid #e2e8f0; 
        font-size: 12px; 
        background: #f8fafc; 
    }
    .checked { 
        background-color: #22c55e !important; 
        color: white !important; 
        border-color: #16a34a !important; 
    }
    
    #customModal { 
        display: none; 
        position: fixed; 
        inset: 0; 
        background: rgba(15, 23, 42, 0.75); 
        align-items: center; 
        justify-content: center; 
        z-index: 1000; 
        backdrop-filter: blur(4px); 
        padding: 16px;
    }

    .tab-btn { 
        padding: 14px 10px; 
        font-weight: 700; 
        transition: 0.3s; 
        border-bottom: 3px solid transparent;
        color: #64748b;
    }
    .tab-btn.active { 
        border-bottom-color: #3b82f6; 
        color: #3b82f6; 
        background: #eff6ff; 
    }
    
    .dep-input { 
        width: 100%; 
        min-width: 100px; 
        padding: 8px; 
        border: 1.5px solid #e2e8f0; 
        border-radius: 8px; 
        font-size: 13px;
    }

    #toast {
        position: fixed;
        bottom: 20px;
        left: 50%;
        transform: translateX(-50%);
        background: #10b981;
        color: white;
        padding: 12px 24px;
        border-radius: 12px;
        font-weight: bold;
        display: none;
        z-index: 2000;
        box-shadow: 0 10px 15px rgba(0,0,0,0.1);
    }

    @media (max-width: 640px) {
        .student-name-col { min-width: 110px; max-width: 110px; font-size: 12px; }
        .box-cell { width: 28px; height: 28px; }
    }
</style>
</head>
<body class="p-2 md:p-6">

<div id="toast">ØªÙ… ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ø¨Ù†Ø¬Ø§Ø­ âœ…</div>

<div class="max-w-full mx-auto">
    <!-- Header -->
    <div class="bg-white p-4 rounded-2xl border border-slate-200 shadow-sm mb-4">
        <div class="flex flex-col md:flex-row md:items-center justify-between gap-4">
            <div>
                <h1 id="pageMainTitle" class="text-xl md:text-3xl font-bold text-slate-800">Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ù„Ø§Ø¨</h1>
                <div id="activeMonthDisplay" class="bg-slate-800 text-blue-400 mt-2 inline-block px-4 py-1 rounded-full font-bold text-xs md:text-sm border border-blue-500/30">
                    Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...
                </div>
            </div>
            <div class="flex flex-wrap gap-2">
                <input type="text" id="search" placeholder="Ø§Ø¨Ø­Ø« Ø¹Ù† Ø·Ø§Ù„Ø¨..." class="flex-1 md:w-64 px-4 py-2 rounded-xl bg-slate-50 border border-slate-200 focus:ring-2 focus:ring-blue-500 outline-none text-sm"/>
                <div class="flex gap-2 w-full md:w-auto">
                    <button id="addStudentBtn" class="flex-1 bg-blue-600 hover:bg-blue-700 text-white py-2 px-4 rounded-xl font-bold transition-all text-xs">Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨</button>
                    <button id="settingsBtn" class="flex-1 bg-slate-800 hover:bg-slate-900 text-white py-2 px-4 rounded-xl font-bold transition-all text-xs">Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Tabs -->
    <div class="flex bg-white rounded-2xl mb-4 border border-slate-200 overflow-hidden shadow-sm">
        <button onclick="switchView('attendance')" id="tabAtt" class="tab-btn active flex-1">ğŸ“… Ø³Ø¬Ù„ Ø§Ù„Ø­Ø¶ÙˆØ±</button>
        <button onclick="switchView('departure')" id="tabDep" class="tab-btn flex-1">ğŸš€ Ø³Ø¬Ù„ Ø§Ù„Ø§Ù†ØµØ±Ø§Ù</button>
    </div>

    <!-- Attendance Table -->
    <div id="attendanceSection" class="table-container border border-slate-200">
        <table class="w-full border-collapse">
            <thead>
                <tr>
                    <th class="student-name-col">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                    <script>for(let d=1; d<=30; d++){document.write(`<th class="text-center min-w-[45px] border-r border-slate-700 text-[10px]">${d}</th>`);}</script>
                </tr>
            </thead>
            <tbody id="attendanceBody" class="divide-y divide-slate-100"></tbody>
        </table>
    </div>

    <!-- Departure Table -->
    <div id="departureSection" class="table-container border border-slate-200 hidden">
        <table class="w-full border-collapse">
            <thead>
                <tr>
                    <th class="student-name-col">Ø§Ø³Ù… Ø§Ù„Ø·Ø§Ù„Ø¨</th>
                    <th class="p-4 text-xs font-bold min-w-[120px]">Ø§Ù„ÙˆØ¬Ù‡Ø© (Ø§Ù„Ù…ÙƒØ§Ù†)</th>
                    <th class="p-4 text-xs font-bold min-w-[110px]">Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„Ùƒ</th>
                    <th class="p-4 text-xs font-bold min-w-[110px]">Ø±Ù‚Ù… Ø¬ÙˆØ§Ù„ Ù…Ø±Ø§ÙÙ‚ Ø§Ùˆ Ø´Ø®Øµ ÙŠØªÙˆØ§Ø¬Ø¯ ÙÙŠ Ø§Ù„ÙˆØ¬Ù‡Ø©</th>
                    <th class="p-4 text-xs font-bold min-w-[90px]">ÙˆÙ‚Øª Ø§Ù„Ø®Ø±ÙˆØ¬</th>
                    <th class="p-4 text-xs font-bold min-w-[90px]">ÙˆÙ‚Øª Ø§Ù„Ø¹ÙˆØ¯Ø©</th>
                    <th class="p-4 text-xs font-bold">Ø¥Ø¬Ø±Ø§Ø¡</th>
                </tr>
            </thead>
            <tbody id="departureBody" class="divide-y divide-slate-100"></tbody>
        </table>
    </div>

    <div id="loader" class="hidden flex justify-center py-12">
        <div class="animate-spin rounded-full h-10 w-10 border-4 border-blue-600 border-t-transparent"></div>
    </div>
</div>

<!-- Modal -->
<div id="customModal">
    <div class="bg-white p-6 rounded-3xl shadow-2xl max-w-sm w-full relative border border-slate-100 max-h-[90vh] overflow-y-auto">
        <div id="modalIcon" class="mx-auto flex items-center justify-center h-14 w-14 rounded-full mb-4 font-bold text-2xl"></div>
        <h3 class="text-lg font-bold text-center text-slate-800 mb-2" id="modalTitle"></h3>
        
        <div id="modalBodyContent" class="mb-6">
            <p class="text-slate-500 text-center text-sm mb-4 leading-relaxed" id="modalMessage"></p>
            
            <div id="errorMsg" class="hidden bg-red-50 text-red-600 p-2 rounded-lg text-xs text-center mb-4 border border-red-100 font-bold">
                âš ï¸ Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±Øº
            </div>

            <div id="modalInputContainer" class="hidden mb-4">
                <input type="password" id="modalInput" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none text-center font-bold tracking-widest" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>

            <div id="modalSelectContainer" class="hidden mb-4">
                <select id="modalSelect" class="w-full px-4 py-3 bg-slate-50 border border-slate-200 rounded-xl focus:ring-2 focus:ring-blue-500 outline-none"></select>
            </div>

            <div id="settingsContainer" class="hidden space-y-3">
                <button onclick="triggerMonthChange()" class="w-full bg-blue-50 text-blue-700 py-3 rounded-xl font-bold text-sm border border-blue-100 hover:bg-blue-100">ğŸ“… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ</button>
                <button onclick="triggerPasswordChange()" class="w-full bg-slate-800 text-white py-3 rounded-xl font-bold text-sm hover:bg-slate-900">ğŸ”‘ ØªØºÙŠÙŠØ± ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±</button>
                <button onclick="triggerDeleteStudent()" class="w-full bg-white text-slate-700 py-3 rounded-xl font-bold text-sm border border-slate-200 hover:bg-slate-50">ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ø³Ù… Ø·Ø§Ù„Ø¨</button>
                
                <div class="space-y-1">
                    <button onclick="triggerClearAttendance()" class="w-full bg-red-50 text-red-700 py-3 rounded-xl font-bold text-sm border border-red-100 hover:bg-red-100">ğŸ§¹ Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„Ø§Øª (Ø­Ø¶ÙˆØ± ÙˆØ§Ù†ØµØ±Ø§Ù)</button>
                    <p class="text-[10px] text-red-500 bg-red-50/50 p-2 rounded-lg border border-red-100/50 leading-relaxed text-center">
                        âš ï¸ <strong>ØªÙ†Ø¨ÙŠÙ‡ Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:</strong> Ù‡Ø°Ø§ Ø§Ù„Ø®ÙŠØ§Ø± Ø³ÙŠØ¤Ø¯ÙŠ Ù„Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ. ÙŠØ³ØªØ®Ø¯Ù… ÙÙ‚Ø· Ø¹Ù†Ø¯ Ø§Ù„Ø±ØºØ¨Ø© ÙÙŠ ØªØµÙÙŠØ© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù„Ø¨Ø¯Ø§ÙŠØ© Ø´Ù‡Ø± Ø¬Ø¯ÙŠØ¯.
                    </p>
                </div>

                <button onclick="triggerPrivacyPolicy()" class="w-full bg-emerald-50 text-emerald-700 py-3 rounded-xl font-bold text-sm border border-emerald-100 hover:bg-emerald-100">ğŸ›¡ï¸ Ø³ÙŠØ§Ø³Ø© Ø§Ù„Ø®ØµÙˆØµÙŠØ©</button>
            </div>

           <div id="privacyContainer" class="hidden space-y-4">
    <div class="bg-slate-50 p-5 rounded-2xl text-slate-600 text-xs leading-relaxed text-right border border-slate-200 shadow-inner">
        
        <p class="font-bold text-slate-800 mb-3 text-center text-sm">
            Ù…ÙŠØ«Ø§Ù‚ Ø§Ù„Ø£Ù…Ø§Ù†<br>
            Ù…ÙŠØ«Ø§Ù‚ Ø§Ù„Ø®ØµÙˆØµÙŠØ© Ø§Ù„Ø±Ù‚Ù…ÙŠ
        </p>

        <ul class="space-y-2">
            <li>âœ¦ ÙŠØªÙ… ØªØ´ÙÙŠØ± ÙˆØªØ®Ø²ÙŠÙ† ÙƒØ§ÙØ© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ø´ÙƒÙ„ Ø³Ø­Ø§Ø¨ÙŠ Ù…ØªØ·ÙˆØ± Ù„Ø¶Ù…Ø§Ù† Ø£Ø¹Ù„Ù‰ Ù…Ø³ØªÙˆÙŠØ§Øª Ø§Ù„Ø£Ù…Ø§Ù† ÙˆØ§Ù„Ø³Ø±ÙŠØ©.</li>
            <li>âœ¦ Ø§Ù„Ù†Ø¸Ø§Ù… Ù…ØµÙ…Ù… Ø­ØµØ±Ø§Ù‹ Ù„Ø¥Ø¯Ø§Ø±Ø© ÙˆØªÙ†Ø¸ÙŠÙ… Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª Ø§Ù„Ù„ÙˆØ¬Ø³ØªÙŠØ© ÙˆØ§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù Ø¨ÙØ¹Ø§Ù„ÙŠØ© Ø±Ù‚Ù…ÙŠØ©.</li>
            <li>âœ¦ Ù†Ù„ØªØ²Ù… Ø¨Ø¹Ø¯Ù… Ù…Ø´Ø§Ø±ÙƒØ© Ø£Ùˆ ØªØ³Ø±ÙŠØ¨ Ø£ÙŠ Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ø¯Ø®Ù„Ø© Ù„Ø£ÙŠ Ø£Ø·Ø±Ø§Ù Ø«Ø§Ù„Ø«Ø© ØªØ­Øª Ø£ÙŠ Ø¸Ø±Ù ÙƒØ§Ù†.</li>
            <li>âœ¦ ØªØ¹ØªÙ…Ø¯ Ø§Ù„ØªÙ‚Ù†ÙŠØ© Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…Ø© Ø¹Ù„Ù‰ Ù…Ø¹Ø§ÙŠÙŠØ± Ø­Ø¯ÙŠØ«Ø© ØªØ¶Ù…Ù† Ø§Ø³ØªÙ…Ø±Ø§Ø±ÙŠØ© Ø§Ù„ÙˆØµÙˆÙ„ ÙˆØ­Ù…Ø§ÙŠØ© Ø§Ù„Ø®ØµÙˆØµÙŠØ© Ø§Ù„ÙØ±Ø¯ÙŠØ©.</li>
        </ul>

        <div class="mt-6 pt-4 border-t border-slate-200 text-center">
            <p class="text-blue-600 font-bold text-[13px] tracking-wide">
                Developed with Passion by<br>
                <span class="text-base">Ù…Ù‡Ø§Ø¨ ØªÙƒÙ†ÙˆÙ„ÙˆØ¬ÙŠ</span>
            </p>
        </div>

    </div>
</div>
</div>

<div id="modalButtons" class="flex gap-3">
    <button id="modalConfirmBtn"
        class="flex-[2] bg-blue-600 hover:bg-blue-700 text-white py-3 rounded-xl font-bold text-sm shadow-lg shadow-blue-200 transition-all">
        ØªØ£ÙƒÙŠØ¯
    </button>
    <button id="modalCancelBtn" onclick="closeModal()"
        class="flex-1 bg-slate-100 hover:bg-slate-200 text-slate-600 py-3 rounded-xl font-bold text-sm transition-all">
        Ø¥Ù„ØºØ§Ø¡
    </button>
</div>
</div>
</div>

<script>
const SUPABASE_URL="https://uobfgucxxvxfxljrfwwk.supabase.co";
const SUPABASE_KEY="sb_publishable_lxOLW0vNtZDCtd4X-2UgiQ_4g60N8Kn";
const sbClient=supabase.createClient(SUPABASE_URL,SUPABASE_KEY);

const attBody=document.getElementById("attendanceBody");
const depBody=document.getElementById("departureBody");
const loader=document.getElementById("loader");
const searchInput=document.getElementById("search");
const modal=document.getElementById("customModal");
const activeMonthDisplay = document.getElementById('activeMonthDisplay');
const toast = document.getElementById('toast');

let currentView = 'attendance';
let studentsList = [];
let pendingAction = null;

const monthsList = ["ÙŠÙ†Ø§ÙŠØ± - 1", "ÙØ¨Ø±Ø§ÙŠØ± - 2", "Ù…Ø§Ø±Ø³ - 3", "Ø£Ø¨Ø±ÙŠÙ„ - 4", "Ù…Ø§ÙŠÙˆ - 5", "ÙŠÙˆÙ†ÙŠÙˆ - 6", "ÙŠÙˆÙ„ÙŠÙˆ - 7", "Ø£ØºØ³Ø·Ø³ - 8", "Ø³Ø¨ØªÙ…Ø¨Ø± - 9", "Ø£ÙƒØªÙˆØ¨Ø± - 10", "Ù†ÙˆÙÙ…Ø¨Ø± - 11", "Ø¯ÙŠØ³Ù…Ø¨Ø± - 12"];

function switchView(view) {
    currentView = view;
    document.getElementById('attendanceSection').classList.toggle('hidden', view !== 'attendance');
    document.getElementById('departureSection').classList.toggle('hidden', view !== 'departure');
    document.getElementById('tabAtt').classList.toggle('active', view === 'attendance');
    document.getElementById('tabDep').classList.toggle('active', view === 'departure');
    document.getElementById('pageMainTitle').textContent = (view === 'attendance') ? 'Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ± Ø§Ù„Ø·Ù„Ø§Ø¨' : 'Ø³Ø¬Ù„ Ø§Ù†ØµØ±Ø§Ù Ø§Ù„Ø·Ù„Ø§Ø¨';
    renderData();
}

function getCurrentTimeFormatted() {
    const now = new Date();
    let hours = now.getHours();
    const minutes = now.getMinutes().toString().padStart(2, '0');
    const ampm = hours >= 12 ? 'Ù…' : 'Øµ';
    hours = hours % 12 || 12; 
    return `${hours}:${minutes} ${ampm}`;
}

async function checkAdminPassword(providedPwd) {
    if(!providedPwd || providedPwd.trim() === "") {
        showErrorOnInput();
        return false;
    }
    const {data} = await sbClient.from("settings").select("value").eq("key_name", "admin_password").single();
    if(data && data.value === providedPwd) {
        return true;
    } else {
        showErrorOnInput();
        return false;
    }
}

function showErrorOnInput(customMsg) {
    const errorDiv = document.getElementById('errorMsg');
    if(customMsg) errorDiv.textContent = customMsg;
    errorDiv.classList.remove('hidden');
    document.getElementById('modalInput').classList.add('border-red-500', 'bg-red-50');
    setTimeout(() => {
        errorDiv.classList.add('hidden');
        errorDiv.textContent = "âš ï¸ Ø§Ù„Ø±Ù…Ø² ØºÙŠØ± ØµØ­ÙŠØ­ Ø£Ùˆ Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±Øº";
        document.getElementById('modalInput').classList.remove('border-red-500', 'bg-red-50');
    }, 3000);
}

function showCustomUI({title, message, type='info', showInput=false, inputType="password", showSelect=false, selectData=[], onConfirm, showSettings=false, showPrivacy=false, hideConfirm=false, hideCancel=false, confirmText="ØªØ£ÙƒÙŠØ¯"}){
    document.getElementById('modalTitle').textContent=title;
    document.getElementById('modalMessage').innerHTML=message;
    document.getElementById('errorMsg').classList.add('hidden');
    const iconDiv=document.getElementById('modalIcon');
    const confirmBtn = document.getElementById('modalConfirmBtn');
    const cancelBtn = document.getElementById('modalCancelBtn');

    confirmBtn.textContent = confirmText;
    confirmBtn.style.display = hideConfirm ? "none" : "block";
    cancelBtn.style.display = hideCancel ? "none" : "block";
    
    ['settingsContainer', 'privacyContainer', 'modalInputContainer', 'modalSelectContainer'].forEach(id => document.getElementById(id).classList.add('hidden'));
    
    if(type==='success') { iconDiv.className="mx-auto flex items-center justify-center h-14 w-14 rounded-full mb-4 bg-green-100 text-green-600"; iconDiv.innerHTML='âœ”'; }
    else if(type==='danger') { iconDiv.className="mx-auto flex items-center justify-center h-14 w-14 rounded-full mb-4 bg-red-100 text-red-600"; iconDiv.innerHTML='âš '; }
    else if(type==='shield') { iconDiv.className="mx-auto flex items-center justify-center h-14 w-14 rounded-full mb-4 bg-emerald-100 text-emerald-600"; iconDiv.innerHTML='ğŸ›¡ï¸'; }
    else { iconDiv.className="mx-auto flex items-center justify-center h-14 w-14 rounded-full mb-4 bg-blue-100 text-blue-600"; iconDiv.innerHTML='â„¹'; }

    if(showInput) { document.getElementById('modalInputContainer').classList.remove('hidden'); document.getElementById('modalInput').type=inputType; document.getElementById('modalInput').value=""; }
    if(showSelect) { 
        document.getElementById('modalSelectContainer').classList.remove('hidden'); 
        document.getElementById('modalSelect').innerHTML = selectData.map(s => `<option value="${s.id||s}">${s.name||s}</option>`).join("");
    }
    if(showSettings) document.getElementById('settingsContainer').classList.remove('hidden');
    if(showPrivacy) document.getElementById('privacyContainer').classList.remove('hidden');

    modal.style.display="flex";
    pendingAction = async () => {
        const val = showSelect ? document.getElementById('modalSelect').value : document.getElementById('modalInput').value;
        if(onConfirm) await onConfirm(val);
    };
}

function closeModal(){ modal.style.display="none"; pendingAction=null; }

function showToast() {
    toast.style.display = 'block';
    setTimeout(() => { toast.style.display = 'none'; }, 3000);
}

document.getElementById('modalConfirmBtn').onclick= async ()=>{ 
    if(pendingAction) await pendingAction(); 
};

async function loadAllData() {
    loader.classList.remove('hidden');
    const {data:students} = await sbClient.from("students").select("*").order("name");
    studentsList = students || [];
    const {data} = await sbClient.from("settings").select("value").eq("key_name", "active_month").single();
    if(data) activeMonthDisplay.textContent = data.value;
    await renderData();
    loader.classList.add('hidden');
}

async function renderData() {
    const filter = searchInput.value.toLowerCase();
    const filtered = studentsList.filter(s => s.name.toLowerCase().includes(filter));

    if(currentView === 'attendance') {
        attBody.innerHTML = "";
        for(let student of filtered) {
            const tr = document.createElement("tr");
            tr.innerHTML = `<td class="student-name-col text-right pr-4">${student.name}</td>`;
            const {data:att} = await sbClient.from("attendance").select("day, check_time").eq("student_id", student.id);
            const attMap = {};
            if(att) att.forEach(a => attMap[a.day] = a.check_time);
            for(let d=1; d<=30; d++) {
                const isChecked = !!attMap[d];
                tr.innerHTML += `<td class="p-0 border-r border-slate-100"><div class="cell-wrapper"><span class="time-label">${attMap[d] || ''}</span><div onclick="handleToggleAtt(this, '${student.id}', ${d}, '${student.name}')" class="box-cell ${isChecked?'checked':''}"> ${isChecked?'âœ”':''} </div></div></td>`;
            }
            attBody.appendChild(tr);
        }
    } else {
        depBody.innerHTML = "";
        for(let student of filtered) {
            const {data:dep} = await sbClient.from("departures").select("*").eq("student_id", student.id).single();
            const d = dep || { destination:'', phone:'', relative_phone:'', out_time:'', return_time:'' };
            const tr = document.createElement("tr");
            tr.innerHTML = `<td class="student-name-col text-right pr-4">${student.name}</td><td class="p-2"><input id="dest-${student.id}" value="${d.destination}" class="dep-input" placeholder="..."></td><td class="p-2"><input id="ph-${student.id}" value="${d.phone}" class="dep-input" placeholder="..."></td><td class="p-2"><input id="rel-${student.id}" value="${d.relative_phone}" class="dep-input" placeholder="..."></td><td class="p-2"><input id="out-${student.id}" value="${d.out_time}" class="dep-input" placeholder="..."></td><td class="p-2"><input id="ret-${student.id}" value="${d.return_time}" class="dep-input" placeholder="..."></td><td class="p-2 text-center"><button onclick="saveDeparture('${student.id}')" class="bg-green-600 text-white px-4 py-1.5 rounded-lg font-bold text-xs">Ø­ÙØ¸</button></td>`;
            depBody.appendChild(tr);
        }
    }
}

async function handleToggleAtt(box, sid, day, sname) {
    const isRemoving = box.classList.contains('checked');
    showCustomUI({
        title: isRemoving ? 'Ø¥Ù„ØºØ§Ø¡ Ø§Ù„Ø­Ø¶ÙˆØ±' : 'ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ±',
        message: `Ù‡Ù„ ØªØ±ÙŠØ¯ ØªØ¹Ø¯ÙŠÙ„ Ø­Ø§Ù„Ø© (${sname})ØŸ`,
        type: isRemoving ? 'danger' : 'success',
        onConfirm: async () => {
            if(isRemoving) { await sbClient.from("attendance").delete().eq("student_id", sid).eq("day", day); } 
            else { await sbClient.from("attendance").upsert({ student_id: sid, day: day, status: 'Ø­Ø¶ÙˆØ±', check_time: getCurrentTimeFormatted() }); }
            closeModal();
            renderData();
        }
    });
}

async function saveDeparture(sid) {
    const payload = {
        student_id: sid,
        destination: document.getElementById(`dest-${sid}`).value,
        phone: document.getElementById(`ph-${sid}`).value,
        relative_phone: document.getElementById(`rel-${sid}`).value,
        out_time: document.getElementById(`out-${sid}`).value,
        return_time: document.getElementById(`ret-${sid}`).value
    };
    loader.classList.remove('hidden');
    await sbClient.from("departures").upsert(payload, {onConflict: 'student_id'});
    loader.classList.add('hidden');
}

function triggerMonthChange() {
    showCustomUI({title:'ØªØ­Ù‚Ù‚', message:'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²:', showInput:true, onConfirm: async (pwd) => {
        if(await checkAdminPassword(pwd)) {
            setTimeout(() => showCustomUI({title:'ØªØºÙŠÙŠØ± Ø§Ù„Ø´Ù‡Ø±', message:'Ø§Ø®ØªØ±:', showSelect:true, selectData:monthsList, onConfirm: async (m) => {
                await sbClient.from("settings").update({value: m}).eq("key_name", "active_month");
                activeMonthDisplay.textContent = m;
                closeModal();
            }}), 300);
        }
    }});
}

function triggerDeleteStudent() {
    showCustomUI({title:'Ø­Ø°Ù Ù†Ù‡Ø§Ø¦ÙŠ', message:'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù„Ø­Ø°Ù Ø§Ù„Ø·Ø§Ù„Ø¨:', showInput:true, onConfirm: async (pwd) => {
        if(await checkAdminPassword(pwd)) {
            setTimeout(() => showCustomUI({title:'Ø§Ø®ØªØ±', message:'Ø³ÙŠØªÙ… Ù…Ø³Ø­ ÙƒÙ„ Ø´ÙŠØ¡ ÙŠØ®Øµ Ø§Ù„Ø·Ø§Ù„Ø¨:', showSelect:true, selectData:studentsList, type:'danger', onConfirm: async (sid) => {
                await sbClient.from("attendance").delete().eq("student_id", sid);
                await sbClient.from("departures").delete().eq("student_id", sid);
                await sbClient.from("students").delete().eq("id", sid);
                closeModal();
                loadAllData();
            }}), 300);
        }
    }});
}

function triggerClearAttendance() {
    showCustomUI({title:'Ù…Ø³Ø­ Ø§Ù„Ø³Ø¬Ù„Ø§Øª', message:'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ù„Ù„Ù…ØªØ§Ø¨Ø¹Ø©:', showInput:true, type:'danger', onConfirm: async (pwd) => {
        if(await checkAdminPassword(pwd)) {
            // Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„Ø«Ø§Ù†ÙŠØ©: ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ
            setTimeout(() => {
                showCustomUI({
                    title: 'ØªØ£ÙƒÙŠØ¯ Ù†Ù‡Ø§Ø¦ÙŠ',
                    message: '<span class="text-red-600 font-bold">Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ø­Ù‚Ø§Ù‹ØŸ</span><br>Ø³ÙŠØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ù†ØµØ±Ø§Ù Ù†Ù‡Ø§Ø¦ÙŠØ§Ù‹ ÙˆÙ„Ø§ ÙŠÙ…ÙƒÙ† Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡Ø§.',
                    type: 'danger',
                    confirmText: 'Ù†Ø¹Ù…ØŒ Ù…Ø³Ø­ Ø§Ù„ÙƒÙ„',
                    onConfirm: async () => {
                        await sbClient.from("attendance").delete().neq("status", "none");
                        await sbClient.from("departures").delete().neq("destination", "none");
                        closeModal();
                        renderData();
                    }
                });
            }, 300);
        }
    }});
}

function triggerPasswordChange() {
    showCustomUI({title:'ØªØºÙŠÙŠØ± Ø§Ù„Ø±Ù…Ø²', message:'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø­Ø§Ù„ÙŠ Ø£ÙˆÙ„Ø§Ù‹:', showInput:true, onConfirm: async (old) => {
        if(await checkAdminPassword(old)) {
            setTimeout(() => showCustomUI({
                title:'Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯', 
                message:'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯:', 
                showInput:true, 
                hideCancel: true, 
                confirmText: "Ø§Ù„ØªØ§Ù„ÙŠ",
                onConfirm: async (n1) => {
                    if(!n1 || n1.trim() === "") {
                        showErrorOnInput("âš ï¸ Ù„Ø§ ÙŠÙ…ÙƒÙ† ØªØ±Ùƒ Ø§Ù„Ø­Ù‚Ù„ ÙØ§Ø±ØºØ§Ù‹");
                        return;
                    }
                    setTimeout(() => showCustomUI({
                        title:'ØªØ£ÙƒÙŠØ¯ Ø§Ù„Ø±Ù…Ø²',
                        message:'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø² Ø§Ù„Ø¬Ø¯ÙŠØ¯ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰ Ù„Ù„ØªØ£ÙƒÙŠØ¯:',
                        showInput:true,
                        hideCancel: true,
                        confirmText: "Ø­ÙØ¸ Ù†Ù‡Ø§Ø¦ÙŠ",
                        onConfirm: async (n2) => {
                            if(n1.trim() !== n2.trim()) {
                                showErrorOnInput("âš ï¸ Ø§Ù„Ø±Ù…ÙˆØ² ØºÙŠØ± Ù…ØªØ·Ø§Ø¨Ù‚Ø©! Ø­Ø§ÙˆÙ„ Ù…Ø±Ø© Ø£Ø®Ø±Ù‰");
                                return;
                            }
                            await sbClient.from("settings").update({value: n1.trim()}).eq("key_name", "admin_password");
                            showToast();
                            showCustomUI({title:'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', message:'', showSettings:true, hideConfirm:true});
                        }
                    }), 300);
                }
            }), 300);
        }
    }});
}

function triggerPrivacyPolicy() { showCustomUI({title:'Ø§Ù„Ø®ØµÙˆØµÙŠØ©', message:'', type:'shield', showPrivacy:true, hideConfirm:true}); }

document.getElementById("settingsBtn").onclick = () => showCustomUI({title:'Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª', message:'', showSettings:true, hideConfirm:true});

document.getElementById("addStudentBtn").onclick = () => {
    showCustomUI({title:'Ø¥Ø¶Ø§ÙØ© Ø·Ø§Ù„Ø¨', message:'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø±Ù…Ø²:', showInput:true, onConfirm: async (pwd) => {
        if(await checkAdminPassword(pwd)) {
            setTimeout(() => showCustomUI({title:'Ø§Ù„Ø§Ø³Ù…', message:'Ø£Ø¯Ø®Ù„ Ø§Ù„Ø§Ø³Ù…:', showInput:true, inputType:'text', onConfirm: async (name) => {
                if(name.trim()) { await sbClient.from("students").insert({name: name.trim()}); closeModal(); loadAllData(); }
            }}), 300);
        }
    }});
};

searchInput.oninput = () => renderData();
window.onload = loadAllData;
</script>
</body>

</html>
